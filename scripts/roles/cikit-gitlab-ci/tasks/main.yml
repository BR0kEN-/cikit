---
- name: Check the configuration
  fail:
    msg: |-
      You have to pass "--gitlab-ci-url=https://gitlab.com" and "--gitlab-ci-token=TOKEN" as command
      line arguments or store them as "gitlab_ci_url: https://gitlab.com" and "gitlab_ci_token: TOKEN"
      variables in "/path/to/project/.cikit/vars/gitlab-ci.yml". Otherwise it won't be possible to
      conigure Gitlab CI runner.
  when: "not gitlab_ci_url or not gitlab_ci_token"

- name: Add repository
  shell: "curl -sL https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | bash"
  args:
    # Suppress warnings about "get_url" usage.
    warn: no
    # Actually, it is APT task below creates this file, but
    # nevermind. We're just not gonna run this second time.
    creates: /usr/bin/gitlab-runner

- name: Install
  apt:
    name: gitlab-runner
    state: installed

- name: Configure
  shell: |-
    gitlab-runner register \
      --non-interactive \
      --url='{{ gitlab_ci_url }}' \
      --shell=bash \
      --locked=false \
      --executor=shell \
      --run-untagged=true \
      --tls-key-file='{{ ssl_folder }}/ssl.key' \
      --tls-cert-file='{{ ssl_folder }}/ssl.crt' \
      --registration-token='{{ gitlab_ci_token }}'
