---
- name: Configure
  replace:
    dest: "{{ phpvirtualbox.path }}/config.php"
    regexp: '^var \${{ item.search }}.*;$'
    replace: "var ${{ item.search }} = '{{ item.replace }}';"
  with_items:
    - search: "username"
      replace: "{{ phpvirtualbox.users.system.name }}"

    - search: "password"
      replace: "{{ phpvirtualbox.users.system.pass }}"

    - search: "vrdeports"
      replace: "9001-9100"

- name: Configure system user
  user:
    name: "{{ phpvirtualbox.users.system.name }}"
    password: "{{ phpvirtualbox.users.system.pass | password_hash('sha512') }}"

- name: Configure GUI user
  include: roles/virtualmachine/tasks/vboxmanage.yml
  args:
    # The "password_hash('sha512')" Jinja filter won't work since it using salt!
    command: "setextradata global phpvb/users/admin/pass $(echo -n '{{ phpvirtualbox.users.gui.pass }}' | sha512sum | cut -d ' ' -f 1)"

- name: Configure service
  template:
    src: phpvirtualbox.j2
    dest: /etc/default/virtualbox

- name: Restart service
  service:
    name: vboxweb-service
    state: restarted
    enabled: yes
